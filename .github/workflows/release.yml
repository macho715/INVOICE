name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ë¦´ë¦¬ìŠ¤ ì „ í…ŒìŠ¤íŠ¸
  pre-release-tests:
    name: Pre-Release Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov build twine
        
    - name: Run full test suite
      run: |
        pytest tests/ -v --cov=. --cov-report=xml --cov-report=html
        
    - name: Run SHPT system integration test
      run: |
        python shpt_audit_system.py --test-mode --verbose
        
    - name: Run DOMESTIC system integration test
      run: |
        python domestic_audit_system.py --test-mode --verbose

  # íŒ¨í‚¤ì§€ ë¹Œë“œ
  build-package:
    name: Build Package
    runs-on: ubuntu-latest
    needs: pre-release-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine
        
    - name: Build package
      run: |
        python -m build
        
    - name: Check package
      run: |
        twine check dist/*
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist
        path: dist/

  # PyPI ë°°í¬
  deploy-pypi:
    name: Deploy to PyPI
    runs-on: ubuntu-latest
    needs: build-package
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v6
      with:
        name: dist
        path: dist/
        
    - name: Publish to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        twine upload dist/*

  # GitHub Release ìƒì„±
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-package, deploy-pypi]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        fetch-depth: 0
        
    - name: Download build artifacts
      uses: actions/download-artifact@v6
      with:
        name: dist
        path: dist/
        
    - name: Generate changelog
      run: |
        # íƒœê·¸ ê°„ ë³€ê²½ì‚¬í•­ ì¶”ì¶œ
        git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 HEAD^)..HEAD > CHANGELOG.md
        
    - name: Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: HVDC Project Invoice Audit System ${{ github.ref_name }}
        body: |
          ## ğŸš€ HVDC Project Invoice Audit System ${{ github.ref_name }}
          
          ### ğŸ“‹ ì£¼ìš” ê¸°ëŠ¥
          - **SHPT ì‹œìŠ¤í…œ**: í•´ìƒ + í•­ê³µ ìš´ì†¡ ì†¡ì¥ ê°ì‚¬ (100% ì„±ê³µë¥ )
          - **DOMESTIC ì‹œìŠ¤í…œ**: ë‚´ë¥™ ìš´ì†¡ ì†¡ì¥ ê°ì‚¬ (ì„¤ê³„ ì™„ë£Œ)
          - **13ê°œ ê²€ì¦ ê·œì¹™**: 8ê°œ ê¸°ë³¸ + 5ê°œ í•­ê³µ ìš´ì†¡ ì „ìš©
          - **COST-GUARD ë°´ë“œ**: PASS/WARN/HIGH/CRITICAL ë¶„ë¥˜
          - **SIM-0092 ì¤€ìˆ˜**: í•­ê³µ ìš´ì†¡ ê°ì‚¬ í‘œì¤€
          
          ### ğŸ“Š ì„±ëŠ¥ ì§€í‘œ
          - **ì²˜ë¦¬ ì†ë„**: 29ê°œ ì‹œíŠ¸ë¥¼ ì•½ 10ì´ˆ ë‚´ ì²˜ë¦¬
          - **ì •í™•ë„**: 100% (95ê°œ í•­ëª© ëª¨ë‘ PASS)
          - **ì•ˆì •ì„±**: ì˜¤ë¥˜ ì—†ì´ ì™„ë£Œ
          - **ì‹ ë¢°ë„**: â‰¥0.95 (ì•ˆì „ ì„ê³„ê°’)
          
          ### ğŸ”§ ì„¤ì¹˜ ë°©ë²•
          ```bash
          pip install invoice-audit-system
          ```
          
          ### ğŸ“š ì‚¬ìš©ë²•
          ```bash
          # SHPT ì‹œìŠ¤í…œ ì‹¤í–‰
          python shpt_audit_system.py
          
          # DOMESTIC ì‹œìŠ¤í…œ ì‹¤í–‰
          python domestic_audit_system.py
          ```
          
          ### ğŸ“„ ë³€ê²½ì‚¬í•­
          $(cat CHANGELOG.md)
          
          ### ğŸ”’ ë³´ì•ˆ ë° ê·œì • ì¤€ìˆ˜
          - FANR ê·œì • ì¤€ìˆ˜ (í•µì‹¬ ë¬¼ì§ˆ ìš´ì†¡)
          - MOIAT ê·œì • ì¤€ìˆ˜ (ìˆ˜ì…/ìˆ˜ì¶œ)
          - PII/NDA ìë™ ìŠ¤í¬ë¦¬ë‹
          - ì™„ì „í•œ ê°ì‚¬ ì¶”ì 
          
          ### ğŸ“ ì§€ì›
          - **í”„ë¡œì íŠ¸**: HVDC Project
          - **íŒŒíŠ¸ë„ˆ**: Samsung C&T Logistics & ADNOCÂ·DSV
          - **ë¬¸ì„œ**: [GitHub Repository](https://github.com/macho715/INVOICE)
        draft: false
        prerelease: false
        
    - name: Upload Release Assets
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: dist/
        asset_name: invoice-audit-system-${{ github.ref_name }}.tar.gz
        asset_content_type: application/gzip

  # Docker ì´ë¯¸ì§€ ë¹Œë“œ (Dockerfileì´ ìˆëŠ” ê²½ìš°)
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: pre-release-tests
    if: hashFiles('Dockerfile') != ''
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          macho715/invoice-audit-system:latest
          macho715/invoice-audit-system:${{ github.ref_name }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # ì•Œë¦¼
  notify:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: [create-release, build-docker]
    if: always()
    
    steps:
    - name: Notify on success
      if: needs.create-release.result == 'success'
      run: |
        echo "âœ… ë¦´ë¦¬ìŠ¤ ì„±ê³µ: HVDC Project Invoice Audit System ${{ github.ref_name }}"
        echo "ğŸ“¦ PyPI ë°°í¬ ì™„ë£Œ"
        echo "ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"
        
    - name: Notify on failure
      if: needs.create-release.result == 'failure'
      run: |
        echo "âŒ ë¦´ë¦¬ìŠ¤ ì‹¤íŒ¨: ë°°í¬ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì˜¤ë¥˜ ë°œìƒ"
        exit 1
